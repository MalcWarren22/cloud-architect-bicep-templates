{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "17676841161013104787"
    }
  },
  "parameters": {
    "environmentName": {
      "type": "string",
      "metadata": {
        "description": "Environment name (dev, test, prod, etc.)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region"
      }
    },
    "namePrefix": {
      "type": "string",
      "defaultValue": "corp",
      "metadata": {
        "description": "Name prefix for resources"
      }
    },
    "vnetAddressSpace": {
      "type": "string",
      "defaultValue": "10.20.0.0/16",
      "metadata": {
        "description": "Address space for the spoke VNet"
      }
    },
    "appServiceSkuName": {
      "type": "string",
      "defaultValue": "P1v3",
      "metadata": {
        "description": "App Service SKU name (e.g. P1v3, B1, S1)"
      }
    },
    "appServiceSkuTier": {
      "type": "string",
      "defaultValue": "PremiumV3",
      "metadata": {
        "description": "App Service SKU tier"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "webapp-landing-zone",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "namePrefix": {
            "value": "[parameters('namePrefix')]"
          },
          "vnetAddressSpace": {
            "value": "[parameters('vnetAddressSpace')]"
          },
          "appServiceSkuName": {
            "value": "[parameters('appServiceSkuName')]"
          },
          "appServiceSkuTier": {
            "value": "[parameters('appServiceSkuTier')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "6724504436038863746"
            }
          },
          "parameters": {
            "environmentName": {
              "type": "string",
              "metadata": {
                "description": "Environment name (dev, test, prod, etc.)"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Azure region"
              }
            },
            "namePrefix": {
              "type": "string",
              "defaultValue": "corp",
              "metadata": {
                "description": "Name prefix for resources"
              }
            },
            "vnetAddressSpace": {
              "type": "string",
              "defaultValue": "10.20.0.0/16",
              "metadata": {
                "description": "Address space for the spoke VNet"
              }
            },
            "appServiceSkuName": {
              "type": "string",
              "defaultValue": "P1v3",
              "metadata": {
                "description": "App Service SKU name (e.g. P1v3, B1, S1)"
              }
            },
            "appServiceSkuTier": {
              "type": "string",
              "defaultValue": "PremiumV3",
              "metadata": {
                "description": "App Service SKU tier"
              }
            }
          },
          "variables": {
            "vnetName": "[format('{0}-{1}-vnet', parameters('namePrefix'), parameters('environmentName'))]",
            "lawName": "[format('{0}-{1}-law', parameters('namePrefix'), parameters('environmentName'))]",
            "appServicePlanName": "[format('{0}-{1}-asp', parameters('namePrefix'), parameters('environmentName'))]",
            "appName": "[format('{0}-{1}-webapi', parameters('namePrefix'), parameters('environmentName'))]",
            "keyVaultName": "[toLower(format('{0}-{1}-kv', parameters('namePrefix'), parameters('environmentName')))]",
            "storageAccountName": "[toLower(replace(format('{0}{1}sa', parameters('namePrefix'), parameters('environmentName')), '-', ''))]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "vnetSpoke",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "vnetName": {
                    "value": "[variables('vnetName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "addressSpace": {
                    "value": "[parameters('vnetAddressSpace')]"
                  },
                  "subnets": {
                    "value": [
                      {
                        "name": "web",
                        "addressPrefix": "10.20.1.0/24"
                      },
                      {
                        "name": "app",
                        "addressPrefix": "10.20.2.0/24"
                      },
                      {
                        "name": "data",
                        "addressPrefix": "10.20.3.0/24"
                      }
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "10533193089252610380"
                    }
                  },
                  "parameters": {
                    "vnetName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the VNet"
                      }
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Location of the VNet"
                      }
                    },
                    "addressSpace": {
                      "type": "string",
                      "metadata": {
                        "description": "Address space of the VNet"
                      }
                    },
                    "subnets": {
                      "type": "array",
                      "metadata": {
                        "description": "Array of subnets: [{ name: string, addressPrefix: string }]"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2024-03-01",
                      "name": "[parameters('vnetName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "subnets",
                            "count": "[length(parameters('subnets'))]",
                            "input": {
                              "name": "[parameters('subnets')[copyIndex('subnets')].name]",
                              "properties": {
                                "addressPrefix": "[parameters('subnets')[copyIndex('subnets')].addressPrefix]"
                              }
                            }
                          }
                        ],
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('addressSpace')]"
                          ]
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "vnetId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                    },
                    "subnetIds": {
                      "type": "array",
                      "copy": {
                        "count": "[length(parameters('subnets'))]",
                        "input": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnets')[copyIndex()].name)]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "monitoringCore",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "lawName": {
                    "value": "[variables('lawName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "appInsightsName": {
                    "value": "[format('{0}-ai', variables('appName'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "5632744608217891851"
                    }
                  },
                  "parameters": {
                    "lawName": {
                      "type": "string",
                      "metadata": {
                        "description": "Log Analytics workspace name"
                      }
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure region"
                      }
                    },
                    "appInsightsName": {
                      "type": "string",
                      "metadata": {
                        "description": "Application Insights name"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.OperationalInsights/workspaces",
                      "apiVersion": "2022-10-01",
                      "name": "[parameters('lawName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "sku": {
                          "name": "PerGB2018"
                        },
                        "retentionInDays": 30
                      }
                    },
                    {
                      "type": "Microsoft.Insights/components",
                      "apiVersion": "2020-02-02",
                      "name": "[parameters('appInsightsName')]",
                      "location": "[parameters('location')]",
                      "kind": "web",
                      "properties": {
                        "Application_Type": "web",
                        "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('lawName'))]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('lawName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "lawId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('lawName'))]"
                    },
                    "appInsightsConnectionString": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').ConnectionString]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "keyVault",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[variables('keyVaultName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "skuName": {
                    "value": "standard"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "11481792528863917790"
                    }
                  },
                  "parameters": {
                    "keyVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Key Vault name"
                      }
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Location"
                      }
                    },
                    "skuName": {
                      "type": "string",
                      "defaultValue": "standard",
                      "metadata": {
                        "description": "SKU name (standard or premium)"
                      }
                    },
                    "enableRbacAuthorization": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Use RBAC for Key Vault auth"
                      }
                    },
                    "enablePurgeProtection": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Enable purge protection (recommended: true for prod)"
                      }
                    },
                    "publicNetworkAccess": {
                      "type": "string",
                      "defaultValue": "Enabled",
                      "allowedValues": [
                        "Enabled",
                        "Disabled"
                      ],
                      "metadata": {
                        "description": "Public network access (Enabled or Disabled)"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults",
                      "apiVersion": "2023-07-01",
                      "name": "[parameters('keyVaultName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "tenantId": "[subscription().tenantId]",
                        "sku": {
                          "name": "[parameters('skuName')]",
                          "family": "A"
                        },
                        "enableRbacAuthorization": "[parameters('enableRbacAuthorization')]",
                        "enablePurgeProtection": "[parameters('enablePurgeProtection')]",
                        "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                        "networkAcls": {
                          "defaultAction": "Allow",
                          "bypass": "AzureServices"
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "keyVaultId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                    },
                    "keyVaultUri": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "storageAccount",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "storageAccountName": {
                    "value": "[variables('storageAccountName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "17118166052150990809"
                    }
                  },
                  "parameters": {
                    "storageAccountName": {
                      "type": "string",
                      "metadata": {
                        "description": "Storage account name (must be globally unique, lower case)"
                      }
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Location"
                      }
                    },
                    "skuName": {
                      "type": "string",
                      "defaultValue": "Standard_LRS",
                      "metadata": {
                        "description": "Sku name (e.g. Standard_LRS)"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2023-01-01",
                      "name": "[parameters('storageAccountName')]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "[parameters('skuName')]"
                      },
                      "kind": "StorageV2",
                      "properties": {
                        "minimumTlsVersion": "TLS1_2",
                        "allowBlobPublicAccess": false,
                        "supportsHttpsTrafficOnly": true
                      }
                    }
                  ],
                  "outputs": {
                    "storageAccountId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                    },
                    "storagePrimaryEndpoint": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').primaryEndpoints.blob]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "webApi",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "appServicePlanName": {
                    "value": "[variables('appServicePlanName')]"
                  },
                  "webAppName": {
                    "value": "[variables('appName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "skuName": {
                    "value": "[parameters('appServiceSkuName')]"
                  },
                  "skuTier": {
                    "value": "[parameters('appServiceSkuTier')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "13760840793741593483"
                    }
                  },
                  "parameters": {
                    "appServicePlanName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the App Service plan"
                      }
                    },
                    "webAppName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Web App"
                      }
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Location for resources"
                      }
                    },
                    "skuName": {
                      "type": "string",
                      "defaultValue": "P1v3",
                      "metadata": {
                        "description": "App Service plan SKU name (P1v3, B1, S1, etc.)"
                      }
                    },
                    "skuTier": {
                      "type": "string",
                      "defaultValue": "PremiumV3",
                      "metadata": {
                        "description": "App Service plan SKU tier"
                      }
                    },
                    "linuxFxVersion": {
                      "type": "string",
                      "defaultValue": "NODE|20-lts",
                      "metadata": {
                        "description": "Runtime stack (Linux) e.g. DOTNETCORE|8.0, NODE|20-lts"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Web/serverfarms",
                      "apiVersion": "2023-12-01",
                      "name": "[parameters('appServicePlanName')]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "[parameters('skuName')]",
                        "tier": "[parameters('skuTier')]",
                        "capacity": 1
                      },
                      "properties": {
                        "reserved": true
                      }
                    },
                    {
                      "type": "Microsoft.Web/sites",
                      "apiVersion": "2023-12-01",
                      "name": "[parameters('webAppName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
                        "siteConfig": {
                          "linuxFxVersion": "[parameters('linuxFxVersion')]",
                          "alwaysOn": true
                        },
                        "httpsOnly": true
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "webAppId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
                    },
                    "webAppDefaultHostName": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-12-01').defaultHostName]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "appServiceDiagnostics",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "webAppName": {
                    "value": "[variables('appName')]"
                  },
                  "workspaceId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'monitoringCore'), '2025-04-01').outputs.lawId.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "16262440960999538301"
                    }
                  },
                  "parameters": {
                    "webAppName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the App Service (Microsoft.Web/sites) to enable diagnostics on"
                      }
                    },
                    "workspaceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Log Analytics workspace resource ID"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Insights/diagnosticSettings",
                      "apiVersion": "2021-05-01-preview",
                      "scope": "[format('Microsoft.Web/sites/{0}', parameters('webAppName'))]",
                      "name": "to-law",
                      "properties": {
                        "workspaceId": "[parameters('workspaceId')]",
                        "logs": [
                          {
                            "category": "AppServiceHTTPLogs",
                            "enabled": true
                          },
                          {
                            "category": "AppServiceConsoleLogs",
                            "enabled": true
                          },
                          {
                            "category": "AppServiceAppLogs",
                            "enabled": true
                          }
                        ],
                        "metrics": [
                          {
                            "category": "AllMetrics",
                            "enabled": true
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'monitoringCore')]"
              ]
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'vnetSpoke'), '2025-04-01').outputs.vnetId.value]"
            },
            "webAppUrl": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'webApi'), '2025-04-01').outputs.webAppDefaultHostName.value]"
            },
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultUri.value]"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'monitoringCore'), '2025-04-01').outputs.lawId.value]"
            },
            "storageAccountId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageAccount'), '2025-04-01').outputs.storageAccountId.value]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "vnetId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'webapp-landing-zone'), '2025-04-01').outputs.vnetId.value]"
    },
    "webAppUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'webapp-landing-zone'), '2025-04-01').outputs.webAppUrl.value]"
    },
    "keyVaultUri": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'webapp-landing-zone'), '2025-04-01').outputs.keyVaultUri.value]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'webapp-landing-zone'), '2025-04-01').outputs.logAnalyticsWorkspaceId.value]"
    },
    "storageAccountId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'webapp-landing-zone'), '2025-04-01').outputs.storageAccountId.value]"
    }
  }
}